#!/bin/bash
# Originally based on:
# http://mah.everybody.org/docs/ssh

[ "$BASH_VERSION" ] && shopt -s nullglob
[ "$ZSH_VERSION" ] && setopt null_glob

declare -a SSH_KEYS=( ${HOME}/.ssh/*_?sa )

SSH_ENV="$HOME/.ssh/environment"
SSH_ADD="/usr/bin/ssh-add"

start_agent () {
  echo "Starting SSH agent..."
  /usr/bin/ssh-agent | sed 's/^echo/#echo/' > "${SSH_ENV}"
  . "${SSH_ENV}"
  echo "Adding keys:"
  echo "${SSH_KEYS[@]}"
  ${SSH_ADD} "${SSH_KEYS[@]}"
}

# Source SSH settings, if applicable
if [ -n "${SSH_KEYS[*]}" ]; then
  if [ -f "${SSH_ENV}" ]; then
    . "${SSH_ENV}"
    ps -ef | grep ${SSH_AGENT_PID} | grep -q ssh-agent || start_agent
  else
    start_agent
  fi
fi
