#!/bin/bash
# Update Homebrew

upgrade_cask () {
  echo "Upgrading cask: $1..."
  brew cask uninstall --force "$1"
  rm -rf "/opt/homebrew-cask/Caskroom/$1"
  brew cask install "$1"
}

if installed brew; then
  # update brew casks -- eventually this should not be necessary
  # (https://github.com/caskroom/homebrew-cask/issues/4678)
  echo "Updating homebrew..."
  brew update
  brew upgrade --all
  brew cleanup
  brew prune
  brew doctor
  echo "Updating homebrew casks..."
  for c in $(brew cask list); do
    info="$(brew cask info $c)"
    if echo "$info" | grep -q "Not installed"; then
      upgrade_cask "$c"
    elif echo "$info" | grep -q ": latest"; then
      if [ "$1" = "-a" ]; then
        upgrade_cask "$c"
      else
        echo "Not upgrading cask: $c because it is non-versioned and the '-a' parameter wasn't specified"
      fi
    fi
  done
  brew cask cleanup

  restore_loc="$(find-dotfiles)/scripts/Brewfile"
  echo "Saving Brewfile to: $restore_loc"
  brew bundle dump --force --file="$restore_loc"
else
  echo "Hombrew is not installed, skipping"
fi
