#!/bin/bash
# Update iterm2

bin_dir="$HOME/.bin"

# Check if iTerm2 is installed
APPLESCRIPT=$(cat <<EOF
on run argv
  try
    tell application "Finder"
      set appname to name of application file id "com.googlecode.iterm2"
      return 1
    end tell
  on error err_msg number err_num
    return 0
  end try
end run
EOF
)

download_if_newer () {
  # Download a file iff URL's HTTP If-Modified-Since header is more recent than
  # the local file timestamp
  url="$1"
  file="$2"
  shift 2
  curl -z "$file" -Lo "$file" "$url" "$@"
}

if [[ "$*" == *--save* ]] && [ $(uname) = "Darwin" ] && [ $(osascript -e "$APPLESCRIPT") = 1 ]; then
  echo "Downloading the latest iterm2 shell integration scripts..."
  download_if_newer "https://iterm2.com/misc/fish_startup.in" "$bin_dir/iterm2_shell_integration.fish"
  download_if_newer "https://iterm2.com/misc/bash_startup.in" "$bin_dir/iterm2_shell_integration.bash"
  download_if_newer "https://iterm2.com/misc/zsh_startup.in" "$bin_dir/iterm2_shell_integration.zsh"
  download_if_newer "https://raw.github.com/gnachman/iTerm2/master/tests/imgls" "$bin_dir/imgls"
  download_if_newer "https://raw.github.com/gnachman/iTerm2/master/tests/imgcat" "$bin_dir/imgcat"
  download_if_newer "https://raw.github.com/gnachman/iTerm2/master/tests/download.sh" "$bin_dir/download.sh"
  download_if_newer "https://raw.github.com/gnachman/iTerm2/master/tests/divider" "$bin_dir/divider"
  chmod +x "$bin_dir/iterm2_shell_integration."* "$bin_dir/imgls" "$bin_dir/imgcat" "$bin_dir/download.sh" "$bin_dir/divider"
else
  echo "Skipping iTerm"
fi
